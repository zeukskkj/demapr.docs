<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Demà Aprendiz - Polo Paraná</title>

<!-- Fontes e Ícones --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
/* -------------------------------------------------------------------------- */
/* PALETA DE CORES                           */
/* -------------------------------------------------------------------------- */
:root{
  --red-dema: #D42C4D;
  --blue-dema: #402FDD;
  --gold-dema: #ED9E06;
  --ink-dema: #11121a;
  --white-dema: #FFFFFF;

  /* Cores base para Liquid Glass no fundo escuro */
  --glass-bg-light: rgba(255, 255, 255, 0.1); 
  --glass-bg-medium: rgba(255, 255, 255, 0.15); 
  --glass-bg-dark: rgba(17, 18, 26, 0.7); 
  --glass-border: rgba(255, 255, 255, 0.2); 
  --glass-blur-amount: 30px; 
  --glass-saturate-amount: 150%;
  --text-primary: var(--white-dema); /* Texto principal branco puro */
  --text-secondary: rgba(255, 255, 255, 0.7); 
  --text-dark: var(--ink-dema); /* Texto escuro */
  --bg-active-white: rgba(255, 255, 255, 0.7); /* Branco brilhante translúcido para estado ativo/hover */
  --shadow-active-white: rgba(255,255,255,.3); /* Sombra branca */

  /* Tamanhos e Gaps */
  --ctrl-w: 320px; 
  --ctrl-h: 56px; 
  --r: 9999px; /* Arredondamento total (pílula) */
  --gap-md: 22px;
  --gap-lg: 32px;
  --rail-w: calc(var(--ctrl-w) * 2 + var(--gap-md));

   @media (max-width: 768px) {
    --ctrl-w: clamp(280px, 85vw, 320px);
    --ctrl-h: 50px;
    --gap-md: 16px;
    --gap-lg: 24px;
    --rail-w: 100%; 
   }
}

/* -------------------------------------------------------------------------- */
/* RESET & FONTES                            */
/* -------------------------------------------------------------------------- */
*{box-sizing:border-box; margin:0; padding:0;}
html,body{height:100%;}
html,body, input, button, a, span, div, p, h1,h2,h3,h4,h5,h6{
  font-family:'Space Grotesk', Arial, sans-serif !important;
  text-transform: uppercase; 
  letter-spacing:.3px; 
  color:var(--text-primary); /* Texto branco puro */
}
input::placeholder { color: var(--text-secondary); } 


/* -------------------------------------------------------------------------- */
/* BACKGROUND ESCURO COM FORMAS CIRCULARES   */
/* -------------------------------------------------------------------------- */
body{
  overflow-x:hidden;
  background-color: var(--ink-dema); 
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  padding: var(--gap-md);
  padding-bottom: 80px; /* Espaço para o botão COP30 fixo */
  position: relative;
  justify-content: flex-start; 
}

#background-abstract-shapes {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    filter: blur(80px) saturate(180%); 
    opacity: 0.4; 
    background: 
        radial-gradient(circle 800px at 15% 10%, var(--red-dema), transparent 70%),
        radial-gradient(circle 900px at 85% 90%, var(--blue-dema), transparent 60%),
        radial-gradient(circle 700px at 40% 50%, var(--gold-dema), transparent 75%);
    background-attachment: fixed;
}

/* -------------------------------------------------------------------------- */
/* HEADER & LOGO                             */
/* -------------------------------------------------------------------------- */
.wrap{width:100%;max-width:1120px;margin:0 auto;padding:16px 16px 0} 
header{
    text-align:center;
    color:var(--text-secondary); 
    letter-spacing:3px;
    font-weight:700;
    margin:6px 0 8px; 
    font-size: 0.9rem;
    text-shadow: 0 1px 5px rgba(0,0,0,0.3);
}
.brandBox{
    height:100px; 
    display:flex;
    align-items:center;
    justify-content:center;
    margin-bottom: var(--gap-lg);
}
.brand{
    height:100%; 
    max-width:350px; 
    object-fit:contain;
    filter:drop-shadow(0 8px 25px rgba(0,0,0,.3)); 
}

/* -------------------------------------------------------------------------- */
/* ELEMENTOS DE INTERFACE (SEM QUADRO GERAL)   */
/* -------------------------------------------------------------------------- */
.hero {
    display: grid;
    justify-items: center;
    gap: 25px; 
    width: 100%;
    max-width: var(--rail-w); 
    margin-top: clamp(20px, 8vh, 60px); 
    z-index: 10; 
}

/* Input de Nome (Liquid Glass - Fica branco no Blur, texto escuro) */
.search{
  width:100%; 
  padding:14px 20px; 
  border:1px solid var(--glass-border); 
  border-radius:var(--r); 
  background: var(--glass-bg-light); /* Começa transparente */ 
  backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
  box-shadow:0 8px 30px rgba(0,0,0,.2); 
  transition: all 0.3s ease;
}
/* Estilo quando preenchido e fora de foco */
.search.filled:not(:focus-within) {
   background: var(--bg-active-white); /* Fica branco */
   border-color: rgba(255, 255, 255, 0.6);
   box-shadow: inset 0 1px 4px rgba(255,255,255,.2), 0 10px 30px var(--shadow-active-white); 
}
.search.filled:not(:focus-within) input {
    color: var(--text-dark); /* Texto escuro quando o fundo é branco */
}

.search:focus-within {
   box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2); 
   border-color: var(--white-dema);
   background: var(--glass-bg-medium); /* Um pouco mais claro ao focar */
}
.search input{
    width:100%;border:0;background:transparent;outline:none;
    font-weight:700;font-size:1rem;text-align:center;
    color: var(--text-primary); /* Texto sempre branco por padrão */
    transition: color 0.3s ease; /* Transição suave para a cor do texto */
}

/* Botões GE/GC Separados (Liquid Glass - Ativo BRANCO) */
.role-selector {
    display: flex;
    gap: var(--gap-md);
    width: var(--rail-w); 
    max-width: 100%;
    justify-content: center;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    pointer-events: none;
}
.role-selector.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.role-btn {
    flex: 1; 
    max-width: var(--ctrl-w); 
    height: var(--ctrl-h);
    border-radius: var(--r); 
    border: 1px solid var(--glass-border);
    background: var(--glass-bg-light); 
    backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
    color: var(--text-secondary); 
    font-weight: 900;
    cursor: pointer;
    box-shadow: 0 10px 22px rgba(0,0,0,.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(.2,.8,.2,1);
    letter-spacing: .5px;
    position: relative;
    isolation: isolate;
    overflow: hidden;
}
.role-btn.active {
    background: var(--bg-active-white); /* Branco brilhante translúcido */
    color: var(--ink-dema); /* Texto escuro */
    box-shadow: inset 0 1px 4px rgba(255,255,255,.2), 0 10px 30px var(--shadow-active-white); 
    border-color: rgba(255, 255, 255, 0.6);
    transform: translateY(-1px) scale(1.02);
    letter-spacing: .8px;
}
.role-btn:not(.active):hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--text-primary);
}
@media (max-width: 768px) {
    .role-selector {
        flex-direction: column; 
        width: var(--ctrl-w); 
        gap: var(--gap-md);
    }
    .role-btn {
         width: 100%; 
    }
}


/* Prateleira de botões */
.shelf{
  position:relative; 
  width:var(--rail-w); 
  height:var(--ctrl-h);
  max-width: 100%; 
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.4s ease 0.1s, transform 0.4s ease 0.1s; 
  pointer-events: none;
}
.shelf.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.slot{ position:absolute; top:0; width:var(--ctrl-w); height:var(--ctrl-h); display:flex; align-items:center; justify-content:center }
.calSlot{ left:0; transition: transform .35s cubic-bezier(.2,.8,.2,1), left .35s cubic-bezier(.2,.8,.2,1), opacity 0.3s ease; }
.folhaSlot{ right:0; transition: transform .35s cubic-bezier(.2,.8,.2,1), opacity .3s ease .1s; } 

.shelf[data-mode="one"] .calSlot{ left:50%; transform: translateX(-50%); opacity: 1; } 
.shelf[data-mode="one"] .folhaSlot{ opacity:0; transform: translateX(20px) scale(.95); pointer-events:none } 

.shelf[data-mode="two"] .calSlot{ left:0; transform: translateX(0); opacity: 1; } 
.shelf[data-mode="two"] .folhaSlot{ opacity:1; transform: translateX(0) scale(1); pointer-events:auto }

@media (max-width: 768px) {
    .shelf {
        height: auto; 
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px; 
        width: 100%; 
    }
    .slot {
        position: relative; 
        left: auto; right: auto; top: auto; 
        width: var(--ctrl-w); 
    }
     .shelf[data-mode="one"] .folhaSlot { display: none; } 
     .shelf[data-mode="two"] .folhaSlot { display: flex; } 
}

/* Botões Buscar (Liquid Glass - BRANCO BRILHANTE NO HOVER/ACTIVE, texto escuro) */
.btn{
  position:relative; isolation:isolate;
  width:var(--ctrl-w); height:var(--ctrl-h); border-radius:var(--r); /* Pílula */
  border: 1px solid var(--glass-border); 
  background: var(--glass-bg-light); /* Fundo vidro padrão escuro */
  backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
  color:var(--text-primary); font-weight:900; cursor:pointer; /* Texto branco */
  box-shadow:0 10px 25px rgba(0,0,0,.15); 
  display:flex; align-items:center; justify-content:center;
  transition: transform .28s cubic-bezier(.2,.8,.2,1), letter-spacing .2s ease, background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
  letter-spacing:.6px;
  overflow: hidden; 
}
/* Efeito de brilho sutil */
.btn::before{ 
  content:""; position:absolute; top:0; left:0; right:0; bottom:0; border-radius:inherit; z-index:-1;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.0) 100%);
  transition: opacity 0.3s ease;
  opacity: 1; 
}
/* Hover e Active ficam brancos */
.btn:hover, .btn:active { 
    transform: translateY(-2px) scale(1.02); 
    background-color: var(--bg-active-white); /* Fica branco */
    color: var(--ink-dema); /* Texto escuro */
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 12px 35px var(--shadow-active-white);
}
.btn:active{ transform: translateY(0) scale(.98); box-shadow: 0 6px 15px rgba(255,255,255,.2); }
.btn:disabled{ opacity:.55; cursor:not-allowed; background: var(--glass-bg-light); color: var(--text-secondary); box-shadow: none; border-color: var(--glass-border); }
.btn:disabled::before { opacity: 0; }
/* Menu de meses dentro do botão branco precisa de texto escuro */
.btn .monthWrap { color: initial; } /* Reseta cor para herdar */


/* Botão COP30 Fixo (Liquid Glass - VERMELHO DA MARCA) */
.cop30-btn {
  position: fixed; 
  bottom: 20px; 
  left: 50%; 
  transform: translateX(-50%); 
  z-index: 50; 
  isolation:isolate;
  width: var(--ctrl-w); 
  max-width: calc(100% - 40px); 
  height:var(--ctrl-h); border-radius:var(--r); 
  border: 1px solid rgba(255, 80, 110, 0.4); 
  background: rgba(212, 44, 77, 0.6); 
  backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
  color:var(--text-primary); font-weight:900; cursor:pointer; 
  box-shadow:0 10px 25px rgba(212, 44, 77, 0.3); 
  display:flex; align-items:center; justify-content:center;
  transition: transform .28s cubic-bezier(.2,.8,.2,1), letter-spacing .2s ease, background-color 0.3s ease, box-shadow 0.3s ease;
  letter-spacing:.6px;
  overflow: hidden; 
  text-decoration: none; 
  gap: 10px; 
}
.cop30-btn i.fa-leaf { 
    font-size: 1.2em; 
    color: var(--white-dema); 
}

.cop30-btn::before{ 
  content:""; position:absolute; top:-60%; left:-60%; width: 220%; height: 220%; border-radius:inherit; z-index:-1;
  background: radial-gradient(circle at center, rgba(255,255,255,.3) 0%, rgba(255,255,255,.05) 40%, transparent 55%);
  transition: transform .5s ease, opacity .5s ease;
  opacity: 0;
  transform: scale(0.8) rotate(15deg);
}
.cop30-btn:hover{ 
    transform: translateX(-50%) translateY(-2px) scale(1.02); 
    background-color: rgba(230, 60, 90, 0.7); 
    box-shadow: 0 12px 30px rgba(212, 44, 77, 0.4);
}
.cop30-btn:active{ 
    transform: translateX(-50%) translateY(0) scale(.98); 
    box-shadow: 0 6px 15px rgba(212, 44, 77, 0.2); 
}

/* menu meses com EFEITO VIDRO */
.monthWrap{ position:relative; width: 100%; } /* Garante que o wrap tenha largura */
.monthMenu{
  position:absolute; bottom:calc(100% + 8px); /* Abre PARA CIMA */ 
  left: 50%; /* Centraliza */
  transform: translateX(-50%); /* Ajuste fino da centralização */
  width:min(var(--ctrl-w), 90vw); 
  max-height:360px; overflow:auto;
  display:none; flex-direction:column; gap:8px; padding:12px; z-index:30;
  background: var(--glass-bg-medium); border-radius:16px; border:1px solid var(--glass-border);
  backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
  box-shadow: 0 -8px 30px rgba(0,0,0,0.2); /* Sombra para cima */
   scrollbar-width: thin; 
   scrollbar-color: rgba(255, 255, 255, 0.3) transparent; 
}
.monthMenu::-webkit-scrollbar { width: 5px; }
.monthMenu::-webkit-scrollbar-track { background: transparent; }
.monthMenu::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px;}

.monthItem{ 
    padding:10px 14px; border-radius:var(--r); /* Pílula */
    background:rgba(255,255,255,0.2); 
    color: var(--text-primary); 
    font-weight:800; cursor:pointer; 
    border: 1px solid rgba(255,255,255,0.1); 
    transition: background-color 0.2s ease, transform 0.2s ease;
    text-align: center;
}
.monthItem:hover{ 
    background:rgba(255,255,255,0.35); 
    transform: scale(1.02);
}
.monthItem.muted { color: var(--text-secondary); cursor: default; background: rgba(255,255,255,0.1); }
.monthItem.err { background: rgba(212, 44, 77, 0.5); color: var(--text-primary); cursor: default;}


/* resultados com EFEITO VIDRO */
.card{ 
    width: 100%;
    max-width:920px; margin:20px auto; padding:24px; 
    background: var(--glass-bg-medium); border-radius:16px; 
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(var(--glass-blur-amount)) saturate(var(--glass-saturate-amount));
}
.title{ font-weight:900; color: var(--text-primary); margin-bottom: 8px; font-size: 1.2rem;} 
.muted{ opacity:.85; color: var(--text-secondary); font-size: 0.9rem;} 
.row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:16px }
.pill{ 
    padding:10px 18px; border-radius:var(--r); /* Pílula */ border:0; 
    background: var(--blue-dema); 
    color:var(--text-primary); 
    font-weight:900; text-decoration:none;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(64,47,221,0.3);
}
.pill:hover {
    background: #5a4ffc; 
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(64,47,221,0.4);
}
/* Link de Abrir/Baixar (Branco) */
a.pill {
    background: rgba(255, 255, 255, 0.7); /* Branco brilhante */
    color: var(--ink-dema); /* Texto escuro */
    box-shadow: 0 4px 15px rgba(255,255,255,0.2);
}
a.pill:hover {
     background: rgba(255, 255, 255, 0.9); 
     box-shadow: 0 6px 20px rgba(255,255,255,0.3);
}
.pill:disabled {
    background: rgba(255, 255, 255, 0.1); 
    color: var(--text-secondary);
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    border: 1px solid var(--glass-border);
}


/* toast com EFEITO VIDRO */
.toast{ 
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%); 
    color:var(--text-primary); padding:12px 20px; border-radius:var(--r); /* Pílula */
    background: var(--glass-bg-dark); 
    border:1px solid rgba(255,255,255,.2); 
    backdrop-filter:blur(10px); 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display:none; z-index:60;
    font-weight: 600;
}
.toast.err { 
    background: rgba(212, 44, 77, 0.7); 
    border-color: rgba(255,255,255,0.4);
    box-shadow: 0 4px 15px rgba(212, 44, 77, 0.4);
} 

/* Spinner - Texto claro */
#spinner { color: var(--text-secondary); font-weight: 600; margin-top: 15px; }

</style>
</head>
<body>
  <div id="background-abstract-shapes"></div> 

  <div class="wrap">
    <header>POLO PARANÁ</header>
    <div class="brandBox">
      <!-- SUA LOGO EM BASE64 VINDA DO Code.gs --><img class="brand" id="brandImg" src="<?= logoDataUri ?>" alt="Demà Aprendiz Logo" loading="lazy" decoding="async"/>
    </div>
  </div>

  <div class="hero">

      <div class="search">
        <input id="fullName" type="text" placeholder="COLOQUE SEU NOME COMPLETO..." autocomplete="off"/>
      </div>

      <!-- Botões Separados para GE/GC --><div class="role-selector">
          <button class="role-btn" data-role="GE">GESTÃO EDUCACIONAL</button>
          <button class="role-btn" data-role="GC">GESTÃO COMPLETA</button>
      </div>
      
      <div class="shelf" id="btnShelf"> <!-- data-mode é controlado via JS --><div class="slot calSlot"><button class="btn" id="btnCal">BUSCAR CALENDÁRIO</button></div>

        <div class="slot folhaSlot">
          <div class="monthWrap">
            <button class="btn" id="btnFolha" aria-haspopup="menu" aria-expanded="false">BUSCAR FOLHA PONTO</button>
            <div class="monthMenu" id="monthMenu">
                <!-- Itens carregados via JS --><div class="monthItem muted" data-key="placeholder">Selecione o mês...</div>
            </div>
          </div>
        </div>
      </div>

      <div id="spinner" style="display:none"><span id="spinText">BUSCANDO…</span></div>
      <div id="result"></div>
  </div>
  
   <!-- Botão COP30 Fixo --><a href="https://zeukskkj.github.io/climachat/" target="_blank" rel="noopener noreferrer" class="cop30-btn">
      <i class="fa-solid fa-leaf"></i> <!-- Ícone Font Awesome Folha --><span>ACESSE O CLIMACHAT COP30</span>
   </a>


<div class="toast" id="toast"></div>

<script>
// Roda o script principal APÓS o carregamento completo da página
document.addEventListener("DOMContentLoaded", function() {

    /* helpers */
    const $=s=>document.querySelector(s);
    const nameInput=$('#fullName');
    const searchBox = $('.search'); // Pega a div .search
    const roleSelector = $('.role-selector'); 
    const roleButtons = [...roleSelector.querySelectorAll('.role-btn')]; 
    const shelf=$('#btnShelf'); 
    const monthMenu=$('#monthMenu');
    const resultEl=$('#result'), spinner=$('#spinner'), spinText=$('#spinText'), toastEl=$('#toast');

    // estado global
    let role='', months=[], monthsLoaded=false; // Inicia sem role definido

    // ----------------------------------------------------------------------------------
    // FUNÇÃO CORRIGIDA: VERIFICA CONDIÇÕES E MOSTRA/ESCONDE BOTÕES/ELEMENTOS
    // Correção: Garante que `roleSelector.classList.add('visible')` é chamada
    // ----------------------------------------------------------------------------------
    function checkConditionsAndToggleButtons() {
        const nameValue = nameInput.value.trim(); // Pega o valor sem espaços no início/fim
        const nameLength = nameValue.length;
        const isRoleSelected = !!roleSelector.querySelector('.role-btn.active'); 
        
        // Console log para verificação do estado
        console.log(`[DEBUG] Verificando: Nome (Tamanho: ${nameLength}) - Role Selecionado: ${isRoleSelected}`); 

        // 1. CONTROLA O SELETOR DE ROLE (GE/GC)
        if (nameLength >= 3) {
            // Se tiver 3+ letras, torna o seletor visível
            roleSelector.classList.add('visible');
            console.log('[DEBUG] roleSelector: VISIBLE');

            // 2. CONTROLA A PRATELEIRA DE BOTÕES (BUSCAR)
            if (isRoleSelected) {
                shelf.classList.add('visible');
            } else {
                shelf.classList.remove('visible'); 
            }

        } else {
            // Se tiver menos de 3 letras, oculta TUDO e reseta o estado.
            roleSelector.classList.remove('visible');
            shelf.classList.remove('visible');
            console.log('[DEBUG] roleSelector: HIDDEN');
            
            // Desativa botão de role se nome for apagado
            const activeButton = roleSelector.querySelector('.role-btn.active');
            if (activeButton) {
                 applyRoleUI(''); // Reseta o role visualmente e o estado para ''
            }
            clearResult(); // Limpa resultados anteriores
        }
    }

    nameInput.addEventListener('input', ()=>{ 
        nameInput.value = nameInput.value.toUpperCase(); 
        checkConditionsAndToggleButtons(); 
        // Remove a classe 'filled' enquanto digita
        searchBox.classList.remove('filled'); 
    });

    // Adiciona listener para o evento 'blur' (quando perde o foco)
    nameInput.addEventListener('blur', () => {
        if (nameInput.value.trim().length > 0) {
            searchBox.classList.add('filled');
        } else {
             searchBox.classList.remove('filled');
        }
    });
     // Adiciona listener para o evento 'focus' para remover a classe
    nameInput.addEventListener('focus', () => {
         searchBox.classList.remove('filled');
    });


    function toast(msg,type = 'info'){ 
        toastEl.textContent = msg; 
        toastEl.className = type === 'err' ? 'toast err' : 'toast';
        toastEl.style.display='block'; 
        toastEl.animate([
            { opacity: 0, transform: 'translateY(10px) translateX(-50%)' },
            { opacity: 1, transform: 'translateY(0) translateX(-50%)' }
        ], { duration: 300, easing: 'ease-out' });

        setTimeout(() => {
             toastEl.animate([
                { opacity: 1, transform: 'translateY(0) translateX(-50%)' },
                { opacity: 0, transform: 'translateY(10px) translateX(-50%)' }
            ], { duration: 300, easing: 'ease-in' }).onfinish = () => {
                 toastEl.style.display='none';
            };
        }, 2500); 
    }

    function showSpinner(t){ if(t) spinText.textContent=t; spinner.style.display='block'; }
    function hideSpinner(){ spinner.style.display='none'; }
    function clearResult(){ resultEl.innerHTML=''; hideSpinner(); monthMenu.style.display='none'; $('#btnFolha').setAttribute('aria-expanded', 'false'); }

    // funcoes de UI
    function applyRoleUI(newRole){
        // Se clicar no botão já ativo, desativa (role vira '')
        if (newRole === role && newRole !== '') {
            role = ''; 
        } else {
            role = newRole; // Atualiza o estado global
        }
        
        roleButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.role === role);
        });
        // Define o modo da prateleira (one ou two)
        shelf.setAttribute('data-mode', role === 'GC' ? 'two' : 'one');
        // Mostra/Esconde a prateleira baseado nas condições gerais
        checkConditionsAndToggleButtons(); 
        clearResult(); 
    }
    // NÃO aplica estado inicial, espera o usuário digitar e clicar

    /* Listener para os botões de Role */
    roleSelector.addEventListener('click', e => {
        const btn = e.target.closest('.role-btn');
        // Só permite clicar se o nome tiver >= 3 letras
        if (!btn || nameInput.value.trim().length < 3) return; 
        
        const newRole = btn.dataset.role;
        if (newRole) {
            applyRoleUI(newRole); 
        }
    });


    /* clique fora fecha meses */
    document.addEventListener('click', (e)=>{ 
        // Fecha o menu de meses se clicar fora dele
        if(!e.target.closest('.monthWrap') && monthMenu.style.display === 'flex') {
            monthMenu.style.display='none'; 
            $('#btnFolha').setAttribute('aria-expanded', 'false');
        }
    });


    // --- Funções de busca (Adaptadas para chamar Google Apps Script) ---
    function runGasScript(functionName, ...args) {
        if (typeof google === 'undefined' || !google || !google.script || !google.script.run) {
            console.error("Google Apps Script API (google.script.run) não está disponível.");
            toast('ERRO: API Apps Script indisponível.', 'err');
            hideSpinner(); // Esconde spinner se a API não estiver lá
            return Promise.reject(new Error("API google.script.run não encontrada.")); 
        }
        return new Promise((resolve, reject) => {
             // Define um timeout para a chamada do Apps Script (ex: 30 segundos)
            let timedOut = false;
            const timeoutId = setTimeout(() => {
                timedOut = true;
                hideSpinner(); // Esconde spinner no timeout
                toast('Tempo limite excedido. A busca demorou muito.', 'err');
                reject(new Error(`Timeout: A função ${functionName} demorou muito para responder.`));
            }, 30000); // 30 segundos

            google.script.run
                .withSuccessHandler(response => {
                    clearTimeout(timeoutId); // Cancela o timeout
                    if (!timedOut) {
                       resolve(response);
                    }
                })
                .withFailureHandler(error => {
                     clearTimeout(timeoutId); // Cancela o timeout
                     if (!timedOut) {
                        console.error(`Falha ao chamar ${functionName}:`, error);
                        reject(error); // Rejeita a Promise com o erro
                     }
                })
                [functionName](...args);
        });
    }

    async function searchCalendarGAS(name) {
        console.log("Chamando searchCalendar no GAS para:", name);
        return await runGasScript('searchCalendar', name);
    }

    async function listFolhaMesesGAS() {
         console.log("Chamando listFolhaMeses no GAS...");
         return await runGasScript('listFolhaMeses');
    }

    async function searchFolhaPontoGAS(name, monthKey) {
         console.log("Chamando searchFolhaPonto no GAS para:", name, "Mês:", monthKey);
         return await runGasScript('searchFolhaPonto', name, monthKey);
    }
    // --- Fim das funções de busca ---

    /* Calendário */
    $('#btnCal').addEventListener('click', async ()=>{ 
      if (nameInput.value.trim().length < 3 || !role) {
           toast('PREENCHA O NOME E SELECIONE A GESTÃO');
           return;
      }
      const name=nameInput.value.trim();
      clearResult();
      showSpinner('BUSCANDO CALENDÁRIO…');
      try {
          const data = await searchCalendarGAS(name); 
          showResults(data, 'cal'); 
      } catch (error) {
          // O erro já deve ter sido logado e toast mostrado pelo runGasScript
          // Apenas esconde o spinner se ainda estiver visível
          hideSpinner();
      }
    });

    function formatDate(ms){ 
        if (!ms || isNaN(ms)) return 'Data indisponível'; 
        try { 
            // Formata data e hora
            return new Date(ms).toLocaleString('pt-BR',{ day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false }); 
        } catch { 
            return 'Data inválida'; 
        } 
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#x27;' }[m])) } 
    function escapeAttr(s){ return String(s || '').replace(/"/g,'&quot;').replace(/</g,'&lt;') } 

    // Função unificada para mostrar resultados (Calendário ou Folha Ponto)
    function showResults(data, kind){
      hideSpinner();
      if(!data || !data.ok){ 
          // Mostra a mensagem de erro específica retornada pelo GAS, se houver
          toast((data && data.msg) || 'ERRO DESCONHECIDO NA BUSCA', 'err'); 
          return; 
      }
      const res = data.results || [];
      const searchName = escapeHtml(nameInput.value); 
      const typeText = kind === 'cal' ? 'calendário' : 'folha ponto';

      if(res.length===0){
        resultEl.innerHTML=`<div class="card"><div class="title">Nada encontrado</div><div class="muted">Não achamos ${typeText} para <strong>${searchName}</strong>${kind === 'fp' ? ' no mês selecionado' : ''}. Verifique nome, gestão, mês e permissões no Drive.</div></div>`;
        return;
      }
      
      // Se for calendário e tiver múltiplos resultados com o mesmo displayName, mostra opções
      if (kind === 'cal' && res.length > 1) {
            const groups = {};
            res.forEach(r => { 
                 const key = r.displayName || r.name || 'Desconhecido'; 
                 (groups[key] ||= []).push(r); 
            }); 
            const names = Object.keys(groups);

            let html = `<div class="card"><div class="title">Resultados de Calendário</div>`;
            if (names.length === 1 && groups[names[0]].length > 1) {
                const arr = groups[names[0]].sort((a, b) => b.updated - a.updated)[0]; // Pega o mais recente do grupo
                const newestData = {id: arr.id, kind: "cal", name: arr.name, updated: arr.updated};
                
                html += `<div class="muted">Encontramos mais de um ${typeText} para <strong>${escapeHtml(names[0])}</strong>. Escolha um:</div>
                         <div class="row">
                           <button class="pill" onclick='openCard(${escapeAttr(JSON.stringify(newestData))})'>Mais recente • ${escapeHtml(formatDate(newestData.updated))}</button>
                         </div>`;
            } else { 
                html += `<div class="muted">Encontramos múltiplos ${typeText} para <strong>${searchName}</strong>. Escolha o correto:</div><div class="row">` +
                        names.sort().map(n => {
                            const r = groups[n].sort((a,b) => b.updated - a.updated)[0]; 
                            const resultData = {id: r.id, kind: "cal", name: r.name, updated: r.updated};
                            return r ? `<button class="pill" onclick='openCard(${escapeAttr(JSON.stringify(resultData))})'>${escapeHtml(r.displayName || r.name)} • ${escapeHtml(formatDate(r.updated))}</button>` : ''; 
                        }).join('') + `</div>`;
            }
            html += `</div>`;
            resultEl.innerHTML = html;
            return; 
      }
      
      // Se for folha ponto ou calendário com resultado único
      const firstResult = res.sort((a, b) => b.updated - a.updated)[0]; 
      openCard(firstResult.id, kind, firstResult.name, firstResult.updated); 
    }

    /* Folha Ponto */
    $('#btnFolha').addEventListener('click', async ()=>{ 
      if(role!=='GC') return; 
      if (nameInput.value.trim().length < 3) {
          toast('PREENCHA O NOME PRIMEIRO');
          return;
      }
      
      const isMenuOpen = monthMenu.style.display === 'flex';
      clearResult(); 

      if (isMenuOpen) {
          monthMenu.style.display = 'none';
          $('#btnFolha').setAttribute('aria-expanded', 'false');
          return;
      }

      $('#btnFolha').setAttribute('aria-expanded', 'true'); 
      
      monthMenu.innerHTML = `<div class="monthItem muted">Carregando...</div>`; 
      monthMenu.style.display='flex'; 
      showSpinner('CARREGANDO MESES…');
      try {
          if (!monthsLoaded || months.length === 0) { 
              const data = await listFolhaMesesGAS(); 
              if (!data || !data.ok) {
                  throw new Error(data.msg || 'Erro ao buscar meses.');
              }
              months = data.months || [];
              monthsLoaded = true; 
          }
          
          monthMenu.innerHTML = months.length
              ? months.map(m=>`<div class="monthItem" data-key="${m.key}">${escapeHtml(m.label)}</div>`).join('')
              : `<div class="monthItem muted">Nenhuma pasta de mês encontrada no Drive</div>`; 
      } catch (error) {
          console.error("Erro ao carregar meses via GAS:", error);
          const errorMsg = typeof error === 'object' && error.message ? error.message : String(error);
          toast(`ERRO: ${errorMsg.substring(0, 100)}`, 'err');
          monthMenu.innerHTML = `<div class="monthItem err">Erro ao carregar meses</div>`;
          monthsLoaded = false; 
      } finally {
          hideSpinner();
          if ($('#btnFolha').getAttribute('aria-expanded') === 'true') {
               monthMenu.style.display='flex';
          } else {
               monthMenu.style.display='none'; 
          }
      }
    });

    monthMenu.onclick = async e =>{ 
      const it=e.target.closest('.monthItem'); if(!it||!it.dataset.key || it.dataset.key === 'placeholder' || it.classList.contains('muted') || it.classList.contains('err')) return; 
      monthMenu.style.display='none';
      $('#btnFolha').setAttribute('aria-expanded', 'false');

      if(role!=='GC') return;
      const name=nameInput.value.trim(); if(name.length<3){ toast('NOME INVÁLIDO'); return; } 
      
      clearResult();
      showSpinner('BUSCANDO FOLHA PONTO…');
      try {
          const data = await searchFolhaPontoGAS(name, it.dataset.key); 
          showResults(data, 'fp'); 
      } catch (error) {
           console.error("Erro ao chamar searchFolhaPonto:", error);
           const errorMsg = typeof error === 'object' && error.message ? error.message : String(error);
           toast(`ERRO: ${errorMsg.substring(0, 100)}`, 'err');
           hideSpinner();
      }
    };

    /* Card final - Link para Visualização no Drive */
    function openCard(fileDataOrId, kindParam, fileNameParam, fileUpdatedParam){
      let fileId, kind, fileName, fileUpdated;

      if (typeof fileDataOrId === 'string' && fileDataOrId.startsWith('{')) { 
          try {
              const parsedData = JSON.parse(fileDataOrId);
              fileId = parsedData.id;
              kind = parsedData.kind;
              fileName = parsedData.name;
              fileUpdated = parsedData.updated;
          } catch (e) {
              fileId = fileDataOrId;
              kind = kindParam;
              fileName = fileNameParam || 'Arquivo';
              fileUpdated = fileUpdatedParam || Date.now();
              console.warn("Falha ao parsear JSON no openCard, usando parâmetros:", fileDataOrId);
          }
      } else { 
          fileId = fileDataOrId;
          kind = kindParam;
          fileName = fileNameParam || 'Arquivo';
          fileUpdated = fileUpdatedParam || Date.now();
      }

      if (!fileId) {
          toast('Erro: ID do arquivo não encontrado para abrir.', 'err');
          console.error("openCard chamado sem fileId válido:", fileDataOrId, kindParam, fileNameParam);
          return;
      }

      const title = (kind === 'cal') ? 'Calendário encontrado!' : 'Folha Ponto encontrada!';
      const viewHref = `https://drive.google.com/file/d/${fileId}/view?usp=sharing`; 
      
      resultEl.innerHTML=`
        <div class="card">
          <div class="title">${title}</div>
          <div class="muted">Arquivo: <strong>${escapeHtml(fileName)}</strong><br>Atualizado: ${escapeHtml(formatDate(fileUpdated))}</div>
          <div class="row">
             <a class="pill" href="${escapeAttr(viewHref)}" target="_blank" rel="noopener">Abrir / Baixar</a>
          </div>
        </div>`;
    }

    // Expõe openCard globalmente para o onclick funcionar
    window.openCard = openCard; 

    // Chama a verificação inicial
    checkConditionsAndToggleButtons();

}); // Fim do DOMContentLoaded
</script>
</body>
</html>
